<html>
  <head>
    <script src="../lib/index.js"></script>
    <script>
      const { DIV, H3, H4, UL, LI } = OEM.Elements;

      // mocks

      function MockBus() {
        const listeners = [];
        const pub = () => listeners.forEach((listener) => listener());
        const sub = (cb) => listeners.push(cb);
        return { pub, sub };
      }

      // Tests

      function todoList(sandbox) {
        const bus = new MockBus();
        const todos = [];
        const dones = [];
        const addTodo = (todo) => (todos.push(todo), bus.pub());
        const addDone = (done) => (dones.push(done), bus.pub());
        const removeDone = (done) => (
          dones.splice(dones.indexOf(done), 1), bus.pub()
        );
        const removeTodo = (todo) => (
          todos.splice(todos.indexOf(todo), 1), bus.pub()
        );

        const el = DIV.subscribe(bus.sub).innerHTML(() =>
          DIV.append(
            H3.innerText("Todo"),
            DIV.append(
              UL.append(
                ...todos.map((todo) =>
                  LI.addEventListener("click", () => {
                    console.log("clicked", todo);
                    addDone(todo);
                  })
                    .addEventListener("click", () => removeTodo(todo))
                    .innerText(todo)
                )
              ),
              UL.append(
                ...dones.map((done) =>
                  LI.addEventListener("click", () => addTodo(done))
                    .addEventListener("click", () => removeDone(done))
                    .style("textDecoration", "line-through")
                    .innerText(done)
                )
              )
            )
          )
        );

        addTodo("Pay Bills");
        addTodo("Buy Groceries");
        addTodo("Clean House");

        const firstItem = el.querySelector("ul > li");
        firstItem.click();
        sandbox.append(el);
        return (
          el.outerHTML ===
            `<div><div><h3>Todo</h3><div><ul><li>Buy Groceries</li><li>Clean House</li></ul><ul><li style="text-decoration: line-through;">Pay Bills</li></ul></div></div></div>` &&
          todos.length === 2 &&
          dones.length === 1
        );
      }

      // Test Runner

      function run() {
        const results = document.querySelector("#test-results");
        const sandbox = document.querySelector("#test-sandbox");

        [todoList].forEach((test) => {
          const result = test(sandbox);

          const ok = document.createElement("span");
          ok.style.color = "green";
          ok.innerText = "✔";

          const bad = document.createElement("span");
          bad.style.color = "red";
          bad.innerText = "𝘅";

          const item = document.createElement("div");
          item.style.display = "flex";
          item.style.gap = "5px";
          item.append(result ? ok : bad, test.name);

          results.append(item);
        });
      }

      window.addEventListener("DOMContentLoaded", run);
    </script>
  </head>
  <body>
    <h1>Integration Tests</h1>
    <h2>Results</h2>
    <div id="test-results"></div>
    <hr />
    <h2>Sandbox</h2>
    <div id="test-sandbox"></div>
  </body>
</html>
